<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>Organograma INSA</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width">
  <!-- Load d3.js -->
  <script src="https://d3js.org/d3.v4.js"></script>
  <style>
    #my_dataviz {
      margin: 20px;
      padding: 20px;
    }

    #departament_detail {
      position: fixed;
      opacity: 0.9;
      padding: 10px;
    }

    .nodeGroups circle {
      fill: #fff;
      stroke: steelblue;
      stroke-width: 1.5px;
    }
  </style>

</head>

<body>
  <!-- Create a div where the graph will take place -->

  <div class="container" align=center style="margin-top:20px;">
    <div class="row">
      <div id="departament_detail" >

      </div>
      <div id="org_details" style="width:50%" align=right>

      </div>

    </div>
  </div>



  <script>
    // set the dimensions and margins of the graph
    var width = 1500;
    var height = 1500;
    var radius = width / 3; // radius of the dendrogram
    var margin = 250;

    // append the svg object to the body of the page
    var svg = d3.select("#org_details")
      .append("svg")
      .attr("width", width)
      .attr("height", height)
      .append("g")
      .attr("transform", "translate(" + radius + "," + radius + ")");

    var col = [];
    d3.json("colaboradores.json", function(d) {
      col = d.tree;
    });
    // read json data
    d3.json("data.json", function(d) {
      var data = d.tree;

      // Create the cluster layout:
      var cluster = d3.cluster()
        .size([360, radius - margin]); // 360 means whole circle. radius - 60 means 60 px of margin around dendrogram

      // Give the data to this cluster layout:
      var root = d3.hierarchy(data, function(d) {
        return d.children;
      });
      cluster(root);

      // Features of the links between nodes:
      var linksGenerator = d3.linkRadial()
        .angle(function(d) {
          return d.x / 180 * Math.PI;
        })
        .radius(function(d) {
          return d.y;
        });

      // Add the links between nodes:
      svg.selectAll('path')
        .data(root.links())
        .enter()
        .append('path')
        .attr("d", linksGenerator)
        .style("fill", 'none')
        .attr("stroke", '#ccc');


      // Add a circle for each node.
      var nodeGroups = svg.selectAll("g")
        .data(root.descendants())
        .enter()
        .append("g")
        .attr("transform", function(d) {
          return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")";
        });


      nodeGroups.append("circle")
        .attr("r", 4)
        .attr("opacity", 1)
        .style("fill", "#69b3a2")
        .on("click", function(d) {
          collaborators_department(d.data);
        });


      nodeGroups.append("text")
        .attr("dy", ".31em")
        .attr("opacity", 1)
        .attr("text-anchor", function(d) {
          return d.x < 180 ? "start" : "end";
        })
        .attr("transform", function(d) {
          return d.x < 180 ? "translate(8)" : "rotate(180)translate(-8)";
        })
        .text(function(d) {
          return d.data.department;
        });


      nodeGroups.selectAll("circle")
        .on("mouseover", function(d, i) {
          d3.select(this).attr("r", 7)

        });

      nodeGroups.selectAll("circle")
        .on("mouseout", function(d, i) {
          d3.select(this).attr("r", 4);
        })
    });

    function update_person(dpt, person) {
      if (person.lattes == null) {
        dpt.append("div")
          .attr("class", "person_detail")
          .html(
            "<table>" +
            "<tr><th>Cargo<td>" + person.post +
            "<tr><th>Nome:<td>" + person.name +
            "<tr><th>Telefone<td>" + person.phone +
            "<tr><th>E-mail<td>" + person.email +
            "</table>")
      } else {
        dpt.append("div")
          .attr("class", "person_detail")
          .html(
            "<table>" +
            "<tr><th>Cargo<td>" + person.post +
            "<tr><th>Nome:<td>" + person.name +
            "<tr><th>Telefone<td>" + person.phone +
            "<tr><th>E-mail<td>" + person.email +
            "<tr><th>lattes<td>" + person.lattes +
            "</table>")
      }
    }

    function collaborators_department(department) {
      var dpt = d3.select("#departament_detail");
      dpt.selectAll("*").remove();
      
      col.collaborators.filter(function(d) {
        if (d.dept_id === department.id) {
          update_person(dpt, d);
        }

      });

    }
  </script>

</body>

</html>
